<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/4.5.0/fabric.min.js"></script>
</head>
<body>
    <div class="canvas-container">
        <canvas id="drawingcanvas" width="500" height="550"></canvas>
    </div>
    <div class="quote-container">
        <input type="text" id="quoteinput" placeholder="Enter your quote">
        <button id="drawbutton">Enable Drawing</button>
        <button onclick="addQuote()">Add</button>
        <button onclick="saveCanvas()">Save</button>
    </div>

    <script>
        var canvas = new fabric.Canvas('drawingcanvas', {
            backgroundColor: '#f1faee'
        });


        var line, isDrawing;

        function enableDrawingMode() {
            canvas.isDrawingMode = true;
            canvas.freeDrawingBrush.color = 'black';
            canvas.freeDrawingBrush.width = 5;
        }

        function disableDrawingMode () {
            canvas.isDrawingMode = false;
        }

        document.getElementById('drawbutton').addEventListener('click', function() {
            if (canvas.isDrawingMode) {
                disableDrawingMode();
                this.textContent = 'Enable Drawing';
            } else {
                enableDrawingMode();
                this.textContent = 'Disable Drawing';
            }
        });

        canvas.on('mouse:down', function(o){
            if (canvas.isDrawingMode) return;
            isDrawing = true;
            var pointer = canvas.getPointer(o.e);
            var points = [ pointer.x, pointer.y, pointer.x, pointer.y ];
            line = new fabric.Line(points, {
                strokeWidth: 5,
                fill: 'black',
                stroke: 'black',
                originX: 'center',
                originY: 'center',
            });
            canvas.add(line);
        });

        canvas.on('mouse:move', function(o){
            if (!isDrawing) return;
            var pointer = canvas.getPointer(o.e);
            line.set({ x2: pointer.x, y2: pointer.y });
            canvas.renderAll();
        });

        canvas.on('mouse:up', function(o){
            if (canvas.isDrawingMode) return;
            isDrawing = false;
        });

        function addQuote() {
            var quote = document.getElementById('quoteinput').value;
            var text = new fabric.Text(quote, {
                left: 100,
                top: 100,
                fontSize: 20,
                fill: 'black'
            });
            canvas.add(text);
        }

        function saveCanvas() {
            var dataURL = canvas.toDataURL({
                format: 'png',
                quality: 0.8
            });
            fetch("{{ url_for('save_image') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ image: dataURL })
            }).then(Response => Response.json())
            .then (data => {
                if (data.success) {
                    window.location.href = "{{ url_for('bookcover') }}";
                } 
            });
        }
    </script>
</body>
</html>